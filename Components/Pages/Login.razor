@page "/login"
@layout LoginLayout
@using blazor_arsip.Models
@using blazor_arsip.Services
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@using System.Net.Http.Json
@using blazor_arsip.Components.Layout
@using Microsoft.AspNetCore.Authorization
@attribute [AllowAnonymous]
@rendermode InteractiveServer

@inject AuthenticationStateProvider AuthStateProvider

<h3>Login</h3>

@if (!string.IsNullOrEmpty(ErrorMessage))
{
    <div class="alert alert-danger">@ErrorMessage</div>
}

<form method="post" action="@($"/Account/Login?returnUrl={Uri.EscapeDataString(GetRedirectUrl())}")" autocomplete="on">
    <div class="form-group">
        <label for="email">Email</label>
        <input id="email" name="Email" type="email" class="form-control" required />
    </div>

    <div class="form-group">
        <label for="password">Password</label>
        <input id="password" name="Password" type="password" class="form-control" required />
    </div>

    <button type="submit" class="btn btn-primary">Login</button>
</form>

<div class="text-center mt-3">
    <p class="text-muted mb-0">
        Don't have an account? 
        <a href="/register" class="text-primary text-decoration-none fw-semibold">Create Account</a>
    </p>
</div>

@code {
    [SupplyParameterFromQuery]
    private string? ReturnUrl { get; set; }

    [SupplyParameterFromQuery]
    private string? error { get; set; }

    private string? ErrorMessage => error == "1" ? "Email atau password salah" : null;

    private string GetRedirectUrl()
    {
        if (!string.IsNullOrEmpty(ReturnUrl))
        {
            return Uri.UnescapeDataString(ReturnUrl);
        }
        return "/dashboard";
    }
}
